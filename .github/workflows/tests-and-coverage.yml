name: Tests & Coverage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: true

      - name: Run tests with coverage
        run: pnpm test:coverage

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage

      - name: Extract coverage percent
        id: cov
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          PCT=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
          if [ -z "$PCT" ] || [ "$PCT" = "null" ]; then PCT=0; fi
          PCT_INT=$(printf "%.0f" "$PCT")
          COLOR=red
          if [ "$PCT_INT" -ge 90 ]; then COLOR=brightgreen;
          elif [ "$PCT_INT" -ge 80 ]; then COLOR=green;
          elif [ "$PCT_INT" -ge 70 ]; then COLOR=yellowgreen;
          elif [ "$PCT_INT" -ge 60 ]; then COLOR=yellow;
          fi
          echo "pct=$PCT_INT" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT

      - name: Generate coverage badge
        uses: emibcn/badge-action@v2
        with:
          label: coverage
          status: "${{ steps.cov.outputs.pct }}%"
          color: "${{ steps.cov.outputs.color }}"
          path: public/coverage.svg

      - name: Commit coverage badge
        if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(ci): update coverage badge [skip ci]"
          file_pattern: public/coverage.svg
